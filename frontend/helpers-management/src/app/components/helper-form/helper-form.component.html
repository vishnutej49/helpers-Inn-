<div class="helper-form-container">
  <h2>{{ isEditMode ? 'Edit Helper' : 'Add New Helper' }}</h2>

  <form [formGroup]="helperForm" (ngSubmit)="showPreview()">
    <div class="form-section">
      <mat-form-field appearance="outline">
        <mat-label>Employee ID</mat-label>
        <input matInput formControlName="employeeCode" readonly>
      </mat-form-field>

      <!-- Type of Service -->
      <mat-form-field appearance="outline">
        <mat-label>Type of Service</mat-label>
        <mat-select formControlName="serviceType" [class.is-invalid]="isValid('serviceType')">
          <mat-option value="" disabled selected>Select Service Type</mat-option>
          <mat-option *ngFor="let service of serviceTypes" [value]="service">{{service}}</mat-option>
        </mat-select>
        <mat-error *ngIf="isValid('serviceType')">Select a Type of Service</mat-error>
      </mat-form-field>

      <!-- Organization -->
      <mat-form-field appearance="outline">
        <mat-label>Organization</mat-label>
        <mat-select formControlName="organization" [class.is-invalid]="isValid('organization')">
          <mat-option value="" disabled selected>Select Organization</mat-option>
          <mat-option *ngFor="let org of organizations" [value]="org">{{org}}</mat-option>
        </mat-select>
        <mat-error *ngIf="isValid('organization')">Select an Organization</mat-error>
      </mat-form-field>

      <!-- Full Name -->
      <mat-form-field appearance="outline">
        <mat-label>Full Name</mat-label>
        <input matInput type="text" formControlName="fullName">
        <mat-error *ngIf="isValid('fullName')">Enter full name</mat-error>
      </mat-form-field>

      <!-- Languages (Dropdown of Checkboxes) -->
      <div class="form-group languages-group">
        <label class="mat-body-1">Languages*</label>
        <div class="languages-dropdown-container">
          <div class="dropdown-header" [class.is-invalid]="isValid('languages')" tabindex="0">
            <span>Select Languages</span>
            <mat-icon class="arrow-icon">arrow_drop_down</mat-icon>
          </div>
          <div class="dropdown-content">
            <mat-checkbox *ngFor="let language of availableLanguages"
                          [value]="language"
                          [checked]="isLanguageSelected(language)"
                          (change)="onChangeLanguage($event)">
              {{language}}
            </mat-checkbox>
          </div>
        </div>
        <mat-error *ngIf="isValid('languages')">Select at least 2 languages</mat-error>
      </div>

      <!-- Gender -->
      <div class="form-group gender-group">
        <label class="mat-body-1">Gender*</label>
        <mat-radio-group formControlName="gender" [class.is-invalid]="isValid('gender')">
          <mat-radio-button *ngFor="let genderOption of genders" [value]="genderOption">
            {{genderOption}}
          </mat-radio-button>
        </mat-radio-group>
        <mat-error *ngIf="isValid('gender')">Gender is required</mat-error>
      </div>

      <!-- E-mail -->
      <mat-form-field appearance="outline">
        <mat-label>E-mail</mat-label>
        <input matInput type="email" formControlName="email">
        <mat-error *ngIf="isValid('email')">Enter valid E-mail</mat-error>
      </mat-form-field>

      <!-- Phone Number -->
      <mat-form-field appearance="outline">
        <mat-label>Phone Number</mat-label>
        <input matInput type="tel" formControlName="phno">
        <mat-error *ngIf="isValid('phno')">Enter a valid 10-digit Phone Number</mat-error>
      </mat-form-field>

      <!-- Vehicle Type -->
      <mat-form-field appearance="outline">
        <mat-label>Vehicle Type</mat-label>
        <mat-select formControlName="vehicleType">
          <mat-option *ngFor="let type of vehicleTypes" [value]="type">{{type}}</mat-option>
        </mat-select>
      </mat-form-field>

      <!-- Vehicle Number (Conditional) -->
      <mat-form-field appearance="outline" *ngIf="helperForm.get('vehicleType')?.value && helperForm.get('vehicleType')?.value !== 'None'">
        <mat-label>Vehicle Number</mat-label>
        <input matInput type="text" formControlName="vehicleNumber">
        <mat-error *ngIf="isValid('vehicleNumber')">Vehicle Number is required if Vehicle Type is selected.</mat-error>
      </mat-form-field>

      <!-- Document Type -->
      <mat-form-field appearance="outline">
        <mat-label>Document Type</mat-label>
        <mat-select formControlName="docType" [class.is-invalid]="isValid('docType')">
          <mat-option value="" disabled selected>Select Document Type</mat-option>
          <mat-option *ngFor="let type of docTypes" [value]="type">{{type}}</mat-option>
        </mat-select>
        <mat-error *ngIf="isValid('docType')">Document Type is required.</mat-error>
      </mat-form-field>

      <!-- KYC Document Upload -->
      <div class="form-group file-upload-group">
        <label for="kycdoc">KYC Document</label>
        <input id="kycdoc" type="file" (change)="onKycSelected($event)" class="file-input"
               [class.is-invalid]="isValid('kycdoc')" accept="application/pdf">
        <div class="file-preview" *ngIf="kycPreviewUrl">
          <img *ngIf="isImageFile(kycPreviewUrl)" [src]="kycPreviewUrl" alt="KYC Preview" class="img-preview">
          <span *ngIf="!isImageFile(kycPreviewUrl)" class="file-name-preview">
            {{ selectedKycFile?.name || 'Document selected' }}
            <a *ngIf="isDataUrlFile(kycPreviewUrl)" [href]="kycPreviewUrl" target="_blank" rel="noopener noreferrer">View</a>
          </span>
        </div>
        <mat-error *ngIf="helperForm.get('kycdoc')?.errors?.['invalidFileType']">Only PDF files are allowed.</mat-error>
        <mat-error *ngIf="isValid('kycdoc') && !helperForm.get('kycdoc')?.errors?.['invalidFileType']">KYC Document is required.</mat-error>
      </div>

      <!-- Profile Photo Upload -->
      <div class="form-group file-upload-group">
        <label for="photoURL">Profile Photo</label>
        <input id="photoURL" type="file" (change)="onPhotoSelected($event)" class="file-input"
               accept="image/jpeg, image/png">
        <div class="file-preview" *ngIf="photoPreviewUrl">
          <img *ngIf="isImageFile(photoPreviewUrl)" [src]="photoPreviewUrl" alt="Photo Preview" class="img-preview">
        </div>
        <mat-error *ngIf="helperForm.get('photoURL')?.errors?.['invalidFileType']">Only JPEG/PNG images are allowed.</mat-error>
      </div>
    </div>

    <div class="form-actions">
      <button mat-stroked-button color="warn" type="button" (click)="onCancel()">Cancel</button>
      <button mat-flat-button color="primary" type="submit" [disabled]="helperForm.invalid || isLoading">
        {{ isEditMode ? 'Update Helper' : 'Add Helper' }}
        <span *ngIf="isLoading" class="spinner"></span>
      </button>
    </div>
  </form>

  <!-- Preview Modal -->
  <div class="modal-overlay" *ngIf="showPreviewModal">
    <div class="modal-content preview-modal">
      <h3>Preview Helper Details</h3>
      <div class="preview-section">
        <div class="preview-item">
          <strong>Employee ID:</strong> {{ previewData?.employeeCode }}
        </div>
      </div>

      <div class="preview-section">
        <h4>Personal Details</h4>
        <div class="preview-item">
          <strong>Full Name:</strong> {{ previewData?.fullName }}
        </div>
        <div class="preview-item">
          <strong>Languages:</strong> {{ previewData?.languages?.join(', ') }}
        </div>
        <div class="preview-item">
          <strong>Phone Number:</strong> {{ previewData?.phno }}
        </div>
        <div class="preview-item">
          <strong>E-mail:</strong> {{ previewData?.email || 'N/A' }}
        </div>
        <div class="preview-item">
          <strong>Gender:</strong> {{ previewData?.gender }}
        </div>
        <div class="preview-item file-preview-container">
          <strong>KYC Document:</strong>
          <img *ngIf="previewData?.kycdoc && isImageFile(previewData?.kycdoc ?? null)" [src]="previewData?.kycdoc" alt="KYC Preview" class="img-preview-small">
          <span *ngIf="previewData?.kycdoc && !isImageFile(previewData?.kycdoc ?? null)">Document selected <a [href]="previewData?.kycdoc" target="_blank" rel="noopener noreferrer">View</a></span>
          <span *ngIf="!previewData?.kycdoc">No KYC document selected</span>
        </div>
        <div class="preview-item file-preview-container">
          <strong>Profile Photo:</strong>
          <img *ngIf="previewData?.photoURL && isImageFile(previewData?.photoURL ?? null)" [src]="previewData?.photoURL" alt="Profile Photo Preview" class="img-preview-small profile-photo-preview">
          <span *ngIf="!previewData?.photoURL">No photo selected</span>
        </div>
      </div>

      <div class="preview-section">
        <h4>Service Details</h4>
        <div class="preview-item">
          <strong>Type of Service:</strong> {{ previewData?.serviceType }}
        </div>
        <div class="preview-item">
          <strong>Organization:</strong> {{ previewData?.organization }}
        </div>
        <div class="preview-item">
          <strong>Vehicle Type:</strong> {{ previewData?.vehicleType || 'N/A' }}
        </div>
        <div class="preview-item" *ngIf="previewData?.vehicleType && previewData?.vehicleType !== 'None'">
          <strong>Vehicle Number:</strong> {{ previewData?.vehicleNumber || 'N/A' }}
        </div>
        <div class="preview-item">
          <strong>Joined On:</strong> {{ previewData?.joinedOn || 'N/A' }}
        </div>
      </div>

      <div class="modal-actions">
        <button mat-stroked-button color="warn" (click)="cancelPreview()">Edit</button>
        <button mat-flat-button color="primary" (click)="confirmSubmit()" [disabled]="isLoading">
          Confirm & Submit
          <span *ngIf="isLoading" class="spinner"></span>
        </button>
      </div>
    </div>
  </div>
</div>
