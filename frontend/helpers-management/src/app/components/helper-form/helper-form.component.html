<div class="helper-form-container">
  <h2>{{ isEditMode ? 'Edit Helper' : 'Add Helper' }}</h2>

  <form [formGroup]="helperForm" (ngSubmit)="showPreview()">
    <mat-stepper #stepper [linear]="true" [selectedIndex]="currentStep">
      
      <!-- Step 1: Helper Details -->
      <mat-step [stepControl]="helperForm" label="Helper Details">
        <ng-template matStepLabel>
          <div class="step-label">
            <span class="step-number">1</span>
            <span class="step-text">Add helper details</span>
          </div>
        </ng-template>
        
        <div class="step-content">
          <div class="form-section">

            <!-- Profile Photo Upload -->
            <div class="form-group file-upload-group profile-photo-upload">
              <div class="profile-photo-upload-container">
                <label for="photoURL" *ngIf="!photoPreviewUrl">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-cloud-upload" viewBox="0 0 16 16">
                    <path fill-rule="evenodd" d="M4.406 1.342A5.53 5.53 0 0 1 8 0c2.69 0 4.923 2 5.166 4.579C14.758 4.804 16 6.137 16 7.773 16 9.569 14.502 11 12.687 11H10a.5.5 0 0 1 0-1h2.688C13.979 10 15 8.988 15 7.773c0-1.216-1.02-2.228-2.313-2.228h-.5v-.5C12.188 2.825 10.328 1 8 1a4.53 4.53 0 0 0-2.941 1.1c-.757.652-1.153 1.438-1.153 2.055v.448l-.445.049C2.064 4.805 1 5.952 1 7.318 1 8.785 2.23 10 3.781 10H6a.5.5 0 0 1 0 1H3.781C1.708 11 0 9.366 0 7.318c0-1.763 1.266-3.223 2.942-3.593.143-.863.698-1.723 1.464-2.383"/>
                    <path fill-rule="evenodd" d="M7.646 4.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 5.707V14.5a.5.5 0 0 1-1 0V5.707L5.354 7.854a.5.5 0 1 1-.708-.708z"/>
                  </svg>
                  Upload Photo
                </label>
                <input id="photoURL" type="file" (change)="onPhotoSelected($event)" class="file-input"
                       accept="image/jpeg, image/png">
                <div *ngIf="photoPreviewUrl">
                  <img *ngIf="isImageFile(photoPreviewUrl)" [src]="photoPreviewUrl" alt="Photo Preview" class="profile-image">
                </div>
                <mat-error *ngIf="helperForm.get('photoURL')?.errors?.['invalidFileType']">Only JPEG/PNG images are allowed.</mat-error>
              </div>
              
            </div>

            <!-- Type of Service -->
            <mat-form-field appearance="outline">
              <mat-label>Type of Service</mat-label>
              <mat-select formControlName="serviceType" [class.is-invalid]="isValid('serviceType')">
                <mat-option value="" disabled selected>Select Service Type</mat-option>
                <mat-option *ngFor="let service of serviceTypes" [value]="service">{{service}}</mat-option>
              </mat-select>
              <mat-error *ngIf="isValid('serviceType')">Select a Type of Service</mat-error>
            </mat-form-field>

            <!-- Organization -->
            <mat-form-field appearance="outline">
              <mat-label>Organization</mat-label>
              <mat-select formControlName="organization" [class.is-invalid]="isValid('organization')">
                <mat-option value="" disabled selected>Select Organization</mat-option>
                <mat-option *ngFor="let org of organizations" [value]="org">{{org}}</mat-option>
              </mat-select>
              <mat-error *ngIf="isValid('organization')">Select an Organization</mat-error>
            </mat-form-field>

            <!-- Full Name -->
            <mat-form-field appearance="outline">
              <mat-label>Full Name</mat-label>
              <input matInput type="text" formControlName="fullName">
              <mat-error *ngIf="isValid('fullName')">Enter full name</mat-error>
            </mat-form-field>

            <!-- Languages (Dropdown of Checkboxes) -->
            <div class="form-group languages-group">
              <label class="mat-body-1">Languages*</label>
            
              <div class="languages-dropdown-container">
                <div
                  class="dropdown-header"
                  [class.is-invalid]="isValid('languages')"
                  tabindex="0"
                  (click)="toggleLanguagesDropdown()"
                >
                  <span>{{ selectedLanguages.length ? selectedLanguages.join(', ') : 'Select Languages' }}</span>
                  <mat-icon class="arrow-icon">arrow_drop_down</mat-icon>
                </div>
            
                <div class="dropdown-content" *ngIf="showLanguagesDropdown">
                  <mat-checkbox
                    *ngFor="let language of availableLanguages"
                    [checked]="isLanguageSelected(language)"
                    (change)="onChangeLanguage(language, $event.checked)"
                  >
                    {{ language }}
                  </mat-checkbox>
                </div>
              </div>
            
              <mat-error *ngIf="isValid('languages')">Select at least 1 languages</mat-error>
            </div>
            
            <!-- Gender -->
            <div class="form-group gender-group">
              <label class="mat-body-1">Gender*</label>
              <mat-radio-group formControlName="gender" [class.is-invalid]="isValid('gender')">
                <mat-radio-button *ngFor="let genderOption of genders" [value]="genderOption">
                  {{genderOption}}
                </mat-radio-button>
              </mat-radio-group>
              <mat-error *ngIf="isValid('gender')">Gender is required</mat-error>
            </div>

            <!-- E-mail -->
            <mat-form-field appearance="outline">
              <mat-label>E-mail</mat-label>
              <input matInput type="email" formControlName="email">
              <mat-error *ngIf="isValid('email')">Enter a valid email address</mat-error>
            </mat-form-field>

            <!-- Phone Number -->
            <mat-form-field appearance="outline">
              <mat-label>Phone Number</mat-label>
              <input matInput type="tel" formControlName="phno">
              <mat-error *ngIf="isValid('phno')">Enter a valid phone number</mat-error>
            </mat-form-field>

            <!-- Vehicle Type -->
            <mat-form-field appearance="outline">
              <mat-label>Vehicle Type</mat-label>
              <mat-select formControlName="vehicleType">
                <mat-option value="" disabled selected>Select Vehicle Type</mat-option>
                <mat-option *ngFor="let vehicle of vehicleTypes" [value]="vehicle">{{vehicle}}</mat-option>
              </mat-select>
            </mat-form-field>

            <!-- Vehicle Number (conditional) -->
            <mat-form-field appearance="outline" *ngIf="helperForm.get('vehicleType')?.value && helperForm.get('vehicleType')?.value !== 'None'">
              <mat-label>Vehicle Number</mat-label>
              <input matInput type="text" formControlName="vehicleNumber">
              <mat-error *ngIf="isValid('vehicleNumber')">Vehicle number is required</mat-error>
            </mat-form-field>

            <!-- Document Type -->
            <mat-form-field appearance="outline">
             <mat-label>Document Type</mat-label>
             <mat-select formControlName="docType" [class.is-invalid]="isValid('docType')">
               <mat-option value="" disabled selected>Select Document Type</mat-option>
               <mat-option *ngFor="let doc of docTypes" [value]="doc">{{doc}}</mat-option>
             </mat-select>
             <mat-error *ngIf="isValid('docType')">Select a document type</mat-error>
            </mat-form-field>

           <!-- KYC Document Upload -->
           <div class="form-group file-upload-group kyc-upload">
            <label class="mat-body-1">KYC Document*</label>
            <div class="kyc-upload-container">
              <label for="kycdoc" *ngIf="!kycPreviewUrl">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-cloud-upload" viewBox="0 0 16 16">
                  <path fill-rule="evenodd" d="M4.406 1.342A5.53 5.53 0 0 1 8 0c2.69 0 4.923 2 5.166 4.579C14.758 4.804 16 6.137 16 7.773 16 9.569 14.502 11 12.687 11H10a.5.5 0 0 1 0-1h2.688C13.979 10 15 8.988 15 7.773c0-1.216-1.02-2.228-2.313-2.228h-.5v-.5C12.188 2.825 10.328 1 8 1a4.53 4.53 0 0 0-2.941 1.1c-.757.652-1.153 1.438-1.153 2.055v.448l-.445.049C2.064 4.805 1 5.952 1 7.318 1 8.785 2.23 10 3.781 10H6a.5.5 0 0 1 0 1H3.781C1.708 11 0 9.366 0 7.318c0-1.763 1.266-3.223 2.942-3.593.143-.863.698-1.723 1.464-2.383"/>
                  <path fill-rule="evenodd" d="M7.646 4.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 5.707V14.5a.5.5 0 0 1-1 0V5.707L5.354 7.854a.5.5 0 1 1-.708-.708z"/>
                </svg>
                Upload KYC Document
              </label>
              <input id="kycdoc" type="file" (change)="onKycSelected($event)" class="file-input"
                     accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
              <div class="file-preview" *ngIf="kycPreviewUrl">
                <img *ngIf="isImageFile(kycPreviewUrl)" [src]="kycPreviewUrl" alt="KYC Preview" class="img-preview">
                <div *ngIf="!isImageFile(kycPreviewUrl)" class="file-info">
                  <mat-icon>description</mat-icon>
                  <span>Document uploaded</span>
                </div>
              </div>
              <mat-error *ngIf="helperForm.get('kycdoc')?.errors?.['invalidFileType']">Only PDF, DOC, DOCX, JPG, JPEG, PNG files are allowed.</mat-error>
            </div>
           </div>

          </div>
        </div>
        

        <div class="step-actions">
          <button mat-button matStepperNext type="button" [disabled]="!helperForm.valid">Next</button>
        </div>

      </mat-step>

      <!-- Step 2: Documents -->
      <mat-step label="Documents">

        <ng-template matStepLabel>
          <div class="step-label">
            <span class="step-number">2</span>
            <span class="step-text">Upload related documents</span>
          </div>
        </ng-template>
        
        
        
        <div class="step-content">
          <div class="form-section">
            <!-- Document Type -->
            <mat-form-field appearance="outline">
              <mat-label>Document Type</mat-label>
              <mat-select formControlName="docType2" [class.is-invalid]="isValid('docType2')">
                <mat-option value="" disabled selected>Select Document Type</mat-option>
                <mat-option *ngFor="let doc of docTypes" [value]="doc">{{doc}}</mat-option>
              </mat-select>
              <mat-error *ngIf="isValid('docType2')">Select a document type</mat-error>
             </mat-form-field>
 
            <!-- KYC Document Upload -->
            <div class="form-group file-upload-group kyc-upload">
             <label class="mat-body-1">KYC Document*</label>
             <div class="kyc-upload-container">
               <label for="kycdoc2" *ngIf="!kycPreviewUrl">
                 <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-cloud-upload" viewBox="0 0 16 16">
                   <path fill-rule="evenodd" d="M4.406 1.342A5.53 5.53 0 0 1 8 0c2.69 0 4.923 2 5.166 4.579C14.758 4.804 16 6.137 16 7.773 16 9.569 14.502 11 12.687 11H10a.5.5 0 0 1 0-1h2.688C13.979 10 15 8.988 15 7.773c0-1.216-1.02-2.228-2.313-2.228h-.5v-.5C12.188 2.825 10.328 1 8 1a4.53 4.53 0 0 0-2.941 1.1c-.757.652-1.153 1.438-1.153 2.055v.448l-.445.049C2.064 4.805 1 5.952 1 7.318 1 8.785 2.23 10 3.781 10H6a.5.5 0 0 1 0 1H3.781C1.708 11 0 9.366 0 7.318c0-1.763 1.266-3.223 2.942-3.593.143-.863.698-1.723 1.464-2.383"/>
                   <path fill-rule="evenodd" d="M7.646 4.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 5.707V14.5a.5.5 0 0 1-1 0V5.707L5.354 7.854a.5.5 0 1 1-.708-.708z"/>
                 </svg>
                 Upload KYC Document
               </label>
               <input id="kycdoc2" type="file" (change)="onKycSelected($event)" class="file-input"
                      accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
               <div class="file-preview" *ngIf="kycPreviewUrl">
                 <img *ngIf="isImageFile(kycPreviewUrl)" [src]="kycPreviewUrl" alt="KYC Preview" class="img-preview">
                 <div *ngIf="!isImageFile(kycPreviewUrl)" class="file-info">
                   <mat-icon>description</mat-icon>
                   <span>Document uploaded</span>
                 </div>
               </div>
               <mat-error *ngIf="helperForm.get('kycdoc2')?.errors?.['invalidFileType']">Only PDF, DOC, DOCX, JPG, JPEG, PNG files are allowed.</mat-error>
             </div>
            </div>
          </div>
        </div>

        <div class="step-actions">
          <button mat-button matStepperPrevious type="button">Back</button>
          <button mat-button matStepperNext type="button" >Next</button>
        </div>
      </mat-step>

      <!-- Step 3: Review -->
      <mat-step label="Review">
        <ng-template matStepLabel>
          <div class="step-label">
            <span class="step-number">3</span>
            <span class="step-text">Check the information and confirm</span>
          </div>
        </ng-template>
        
        <div class="step-content">
          <div class="review-section">
            <h3>Review Helper Information</h3>
            <p>Please review all the information before submitting.</p>
            
            <div class="preview-data">
              <div class="preview-item">
                <strong>Full Name:</strong> {{ helperForm.get('fullName')?.value }}
              </div>
              <div class="preview-item">
                <strong>Service Type:</strong> {{ helperForm.get('serviceType')?.value }}
              </div>
              <div class="preview-item">
                <strong>Organization:</strong> {{ helperForm.get('organization')?.value }}
              </div>
              <div class="preview-item">
                <strong>Phone:</strong> {{ helperForm.get('phno')?.value }}
              </div>
              <div class="preview-item">
                <strong>Email:</strong> {{ helperForm.get('email')?.value || 'N/A' }}
              </div>
              <div class="preview-item">
                <strong>Gender:</strong> {{ helperForm.get('gender')?.value }}
              </div>
              <div class="preview-item">
                <strong>Languages:</strong> {{ allLanguages.value.join(', ') }}
              </div>
            </div>
          </div>
        </div>

        <div class="step-actions">
          <button mat-button matStepperPrevious type="button">Back</button>
          <button mat-flat-button color="primary" type="submit" [disabled]="isLoading">
            {{ isLoading ? 'Submitting...' : (isEditMode ? 'Update Helper' : 'Add Helper') }}
          </button>
        </div>
      </mat-step>

    </mat-stepper>
  </form>

  <!-- Cancel Button -->
  <div class="form-actions">
    <button mat-stroked-button (click)="onCancel()">Cancel</button>
  </div>
</div>
